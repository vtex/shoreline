name: Enviar Issues de Design no Slack

on:
  schedule:
    - cron: '0 9 * * 1/2'  # Enviar a cada duas semanas às 9h (UTC)
  workflow_dispatch:  # Permite disparar manualmente

jobs:
  post-to-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Buscar últimas issues com label 'design'
        uses: actions/github-script@v6
        id: issues
        with:
          script: |
            const issues = await github.issues.listForRepo({
              owner: 'vtex',
              repo: 'shoreline',
              state: 'open',
              labels: 'design',
              per_page: 10,
            });

            // Filtra as 2 últimas issues com a label 'design'
            const latest = issues.data
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(0, 2)
              .map(issue => `• <${issue.html_url}|${issue.title}>`)
              .join('\n');

            // URLs para as listas filtradas
            const baseUrl = `https://github.com/vtex/shoreline/issues`;
            const designIssuesUrl = `${baseUrl}?q=label%3Adesign+is%3Aopen`;
            const designGoodFirstIssuesUrl = `${baseUrl}?q=label%3Adesign+label%3Agood+first+issue+is%3Aopen`;

            // A mensagem a ser enviada ao Slack
            const message = `
              📝 *Últimas issues com label \`design\`:*
              ${latest}

              🔗 <${designIssuesUrl}|Ver todas com \`design\`>
              🔗 <${designGoodFirstIssuesUrl}|Ver \`design\` + \`good first issue\`>
            `.trim();

            // Salva a mensagem em uma variável de saída
            return message;

      - name: Gravar mensagem em arquivo temporário
        run: echo "${{ steps.issues.outputs.result }}" > message.txt

      - name: Enviar para o Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: '{"channel": "U05107MCWSD", "text": "$(cat message.txt)"}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
